<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="app">
  <nav class="tabbar" id="tabbar">
    <a href="#" data-page="upload" class="tab-item active">読込</a>
    <a href="#" data-page="info" class="tab-item">Info</a>
    <a href="#" data-page="bone" class="tab-item">Bone</a>
    <a href="#" data-page="morph" class="tab-item">Morph</a>
    <a href="#" data-page="curve" class="tab-item">Curve</a>
  </nav>

  <main class="content" id="content">
    <div class="page active" id="upload">
      <div class="upload-area" id="dropArea">
        <div class="upload-text">VMDファイルをドロップ</div>
        <div class="upload-subtext">または</div>
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
          ファイルを選択
        </button>
        <input type="file" id="fileInput" class="file-input" accept=".vmd">
      </div>
      <div id="uploadResult"></div>
    </div>

    <div class="page" id="info">
      <div id="infoContent" class="info-content">
        <p class="placeholder">ファイルを読み込んでください</p>
      </div>
    </div>

    <div class="page" id="bone">
      <div id="boneList" class="item-list grid-2">
        <p class="placeholder">ファイルを読み込んでください</p>
      </div>
      <div id="boneDetail" class="info-content detail-wrap" style="margin-top:16px;">
        <p class="placeholder">ボーンを選択してください</p>
      </div>
    </div>

    <div class="page" id="morph">
      <div id="morphList" class="item-list grid-2">
        <p class="placeholder">ファイルを読み込んでください</p>
      </div>
      <div id="morphDetail" class="info-content detail-wrap" style="margin-top:16px;">
        <p class="placeholder">モーフを選択してください</p>
      </div>
    </div>

    <div class="page" id="curve">
      <div class="curve-input-area">
        <input type="text" id="curveInput" class="curve-input" placeholder="0.335, 0.670, 0.665, 1.000">
      </div>
      <div class="curve-canvas-wrap">
        <canvas id="curveCanvas" width="400" height="400"></canvas>
      </div>
    </div>
  </main>
</div>

<script src="others.js"></script>
<script>
let currentVmdData = null;
let currentFileName = '';
let vmdStructure = null;

let selectedBoneName = null;
let selectedMorphName = null;

const tabItems = document.querySelectorAll('.tab-item');
const pages = document.querySelectorAll('.page');

tabItems.forEach(item => {
  item.addEventListener('click', (e) => {
    e.preventDefault();
    const targetPage = item.dataset.page;

    tabItems.forEach(t => t.classList.remove('active'));
    pages.forEach(p => p.classList.remove('active'));

    item.classList.add('active');
    document.getElementById(targetPage).classList.add('active');
  });
});

const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');

dropArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropArea.classList.add('dragover');
});

dropArea.addEventListener('dragleave', () => {
  dropArea.classList.remove('dragover');
});

dropArea.addEventListener('drop', (e) => {
  e.preventDefault();
  dropArea.classList.remove('dragover');
  const file = e.dataTransfer.files[0];
  if (file) processFile(file);
});

fileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (file) processFile(file);
});

function processFile(file) {
  if (!file.name.toLowerCase().endsWith('.vmd')) {
    showMessage('uploadResult', 'VMDファイルを選択してください', 'error');
    return;
  }

  currentFileName = file.name;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      currentVmdData = new Uint8Array(e.target.result);
      vmdStructure = parseVMD(currentVmdData);

      selectedBoneName = null;
      selectedMorphName = null;

      showMessage('uploadResult', 'ファイルを読み込みました: ' + currentFileName, 'success');

      updateInfoPage();
      updateBonePage();
      updateMorphPage();
    } catch (error) {
      showMessage('uploadResult', 'ファイルの解析に失敗しました: ' + error.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

function showMessage(elementId, message, type) {
  const element = document.getElementById(elementId);
  element.innerHTML = `<div class="message message-${type}">${escapeHtml(message)}</div>`;
}

function escapeHtml(str) {
  return (str ?? '').toString()
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function encodeAttr(str) {
  return encodeURIComponent((str ?? '').toString());
}

function decodeAttr(str) {
  return decodeURIComponent((str ?? '').toString());
}

function formatF(v) {
  if (!Number.isFinite(v)) return String(v);
  return (Math.round(v * 1000000) / 1000000).toString();
}

function buildGroupMap(items) {
  const map = new Map();
  for (const it of items) {
    const key = it.name;
    if (!map.has(key)) map.set(key, []);
    map.get(key).push(it);
  }
  return map;
}

function updateInfoPage() {
  const info = vmdStructure;
  const html = `
    <div class="info-section">
      <div class="info-label">File</div>
      <div class="info-value">${escapeHtml(currentFileName)}</div>
    </div>
    <div class="info-section">
      <div class="info-label">Format</div>
      <div class="info-value">${escapeHtml(info.header)}</div>
    </div>
    <div class="info-section">
      <div class="info-label">Model</div>
      <div class="info-value">${escapeHtml(info.modelName)}</div>
    </div>
    <div class="info-section">
      <div class="info-label">Bone</div>
      <div class="info-value">${info.boneKeyCount.toLocaleString()}</div>
    </div>
    <div class="info-section">
      <div class="info-label">Morph</div>
      <div class="info-value">${info.morphKeyCount.toLocaleString()}</div>
    </div>
    <div class="info-section">
      <div class="info-label">IK</div>
      <div class="info-value">${info.ikCount > 0 ? 'ON' : 'OFF'}</div>
    </div>
  `;
  document.getElementById('infoContent').innerHTML = html;
}

function updateBonePage() {
  const map = buildGroupMap(vmdStructure.bones);
  const names = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,'ja'));

  const html = names.map(name => {
    const count = map.get(name).length;
    return `
      <div class="item-row bone-row" data-name="${encodeAttr(name)}">
        <div class="item-name">
          <div class="item-pill">${escapeHtml(name)}</div>
        </div>
        <div class="item-count">${count}f</div>
      </div>
    `;
  }).join('');

  document.getElementById('boneList').innerHTML = html || '<p class="placeholder">データなし</p>';

  document.querySelectorAll('.bone-row').forEach(row => {
    row.addEventListener('click', () => {
      selectedBoneName = decodeAttr(row.dataset.name);
      renderBoneDetail(selectedBoneName);
    });
  });

  if (selectedBoneName && map.has(selectedBoneName)) {
    renderBoneDetail(selectedBoneName);
  } else {
    document.getElementById('boneDetail').innerHTML = '<p class="placeholder">ボーンを選択してください</p>';
  }
}

function renderBoneDetail(name) {
  const detail = document.getElementById('boneDetail');
  const map = buildGroupMap(vmdStructure.bones);
  const listAll = (map.get(name) || []).slice().sort((a,b)=>a.frame-b.frame);

  const rows = listAll.map((b) => {
    return `
      <div class="info-section kf-row">
        <div class="kf-left">F:${b.frame}</div>
        <div class="kf-right">
          <div class="kf-line">pos(x,y,z) = ${formatF(b.pos.x)},${formatF(b.pos.y)},${formatF(b.pos.z)}</div>
          <div class="kf-line">  X curve = ${formatF(b.curve.x[0])}, ${formatF(b.curve.x[1])}, ${formatF(b.curve.x[2])}, ${formatF(b.curve.x[3])}</div>
          <div class="kf-line">  Y curve = ${formatF(b.curve.y[0])}, ${formatF(b.curve.y[1])}, ${formatF(b.curve.y[2])}, ${formatF(b.curve.y[3])}</div>
          <div class="kf-line">  Z curve = ${formatF(b.curve.z[0])}, ${formatF(b.curve.z[1])}, ${formatF(b.curve.z[2])}, ${formatF(b.curve.z[3])}</div>
          <div class="kf-line">rot(x,y,z,w) = ${formatF(b.rot.x)},${formatF(b.rot.y)},${formatF(b.rot.z)},${formatF(b.rot.w)}</div>
          <div class="kf-line">  R curve = ${formatF(b.curve.r[0])}, ${formatF(b.curve.r[1])}, ${formatF(b.curve.r[2])}, ${formatF(b.curve.r[3])}</div>
        </div>
      </div>
    `;
  }).join('');

  detail.innerHTML = `
    <div class="detail-head">
      <div class="detail-name">${escapeHtml(name)}</div>
    </div>
    <div class="detail-scroll">
      ${rows || '<p class="placeholder">データなし</p>'}
    </div>
  `;
}

function updateMorphPage() {
  const map = buildGroupMap(vmdStructure.morphs);
  const names = Array.from(map.keys()).sort((a,b)=>a.localeCompare(b,'ja'));

  const html = names.map(name => {
    const count = map.get(name).length;
    return `
      <div class="item-row morph-row" data-name="${encodeAttr(name)}">
        <div class="item-name">
          <div class="item-pill">${escapeHtml(name)}</div>
        </div>
        <div class="item-count">${count}f</div>
      </div>
    `;
  }).join('');

  document.getElementById('morphList').innerHTML = html || '<p class="placeholder">データなし</p>';

  document.querySelectorAll('.morph-row').forEach(row => {
    row.addEventListener('click', () => {
      selectedMorphName = decodeAttr(row.dataset.name);
      renderMorphDetail(selectedMorphName);
    });
  });

  if (selectedMorphName && map.has(selectedMorphName)) {
    renderMorphDetail(selectedMorphName);
  } else {
    document.getElementById('morphDetail').innerHTML = '<p class="placeholder">モーフを選択してください</p>';
  }
}

function renderMorphDetail(name) {
  const detail = document.getElementById('morphDetail');
  const map = buildGroupMap(vmdStructure.morphs);
  const listAll = (map.get(name) || []).slice().sort((a,b)=>a.frame-b.frame);

  const rows = listAll.map((m) => {
    return `
      <div class="info-section kf-row">
        <div class="kf-left">F:${m.frame}</div>
        <div class="kf-right">
          <div class="kf-line">${formatF(m.weight)}</div>
        </div>
      </div>
    `;
  }).join('');

  detail.innerHTML = `
    <div class="detail-head">
      <div class="detail-name">${escapeHtml(name)}</div>
    </div>
    <div class="detail-scroll">
      ${rows || '<p class="placeholder">データなし</p>'}
    </div>
  `;
}

const curveInput = document.getElementById('curveInput');
const curveCanvas = document.getElementById('curveCanvas');
const curveCtx = curveCanvas.getContext('2d');

function resizeCurveCanvas() {
  const wrap = document.querySelector('.curve-canvas-wrap');
  const rect = wrap.getBoundingClientRect();
  const size = Math.min(rect.width, rect.height) * 0.8;
  const dpr = window.devicePixelRatio || 1;
  
  curveCanvas.width = size * dpr;
  curveCanvas.height = size * dpr;
  curveCanvas.style.width = size + 'px';
  curveCanvas.style.height = size + 'px';
  
  curveCtx.scale(dpr, dpr);
  drawCurve();
}

curveInput.addEventListener('input', () => {
  drawCurve();
});

window.addEventListener('resize', resizeCurveCanvas);

function drawCurve() {
  const input = curveInput.value.trim();
  const parts = input.split(',').map(s => parseFloat(s.trim()));
  
  const size = parseFloat(curveCanvas.style.width);
  
  curveCtx.clearRect(0, 0, size, size);
  
  if (parts.length !== 4 || parts.some(v => isNaN(v))) {
    curveCtx.fillStyle = '#808080';
    curveCtx.font = '14px sans-serif';
    curveCtx.textAlign = 'center';
    curveCtx.fillText('4つの数値を入力してください', size / 2, size / 2);
    return;
  }
  
  const [ax, ay, bx, by] = parts;
  
  const padding = size * 0.1;
  const gridSize = size - padding * 2;
  
  curveCtx.strokeStyle = '#383838';
  curveCtx.lineWidth = 2;
  curveCtx.strokeRect(padding, padding, gridSize, gridSize);
  
  curveCtx.strokeStyle = '#555';
  curveCtx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const pos = (gridSize / 4) * i;
    curveCtx.beginPath();
    curveCtx.moveTo(padding + pos, padding);
    curveCtx.lineTo(padding + pos, padding + gridSize);
    curveCtx.stroke();
    
    curveCtx.beginPath();
    curveCtx.moveTo(padding, padding + pos);
    curveCtx.lineTo(padding + gridSize, padding + pos);
    curveCtx.stroke();
  }
  
  const p0x = padding;
  const p0y = padding + gridSize;
  const p1x = padding + ax * gridSize;
  const p1y = padding + gridSize - ay * gridSize;
  const p2x = padding + bx * gridSize;
  const p2y = padding + gridSize - by * gridSize;
  const p3x = padding + gridSize;
  const p3y = padding;
  
  curveCtx.strokeStyle = '#64b5f6';
  curveCtx.lineWidth = 3;
  curveCtx.beginPath();
  curveCtx.moveTo(p0x, p0y);
  curveCtx.bezierCurveTo(p1x, p1y, p2x, p2y, p3x, p3y);
  curveCtx.stroke();
  
  curveCtx.fillStyle = '#ff5252';
  curveCtx.beginPath();
  curveCtx.arc(p1x, p1y, 6, 0, Math.PI * 2);
  curveCtx.fill();
  
  curveCtx.fillStyle = '#ffab40';
  curveCtx.beginPath();
  curveCtx.arc(p2x, p2y, 6, 0, Math.PI * 2);
  curveCtx.fill();
  
  curveCtx.strokeStyle = '#ff5252';
  curveCtx.lineWidth = 1.5;
  curveCtx.setLineDash([4, 4]);
  curveCtx.beginPath();
  curveCtx.moveTo(p0x, p0y);
  curveCtx.lineTo(p1x, p1y);
  curveCtx.stroke();
  
  curveCtx.strokeStyle = '#ffab40';
  curveCtx.beginPath();
  curveCtx.moveTo(p3x, p3y);
  curveCtx.lineTo(p2x, p2y);
  curveCtx.stroke();
  curveCtx.setLineDash([]);
}

resizeCurveCanvas();
</script>
</body>
</html>
